From 5b4ee4f6adca466d4c15d4661db10c8e7b2e6ae4 Mon Sep 17 00:00:00 2001
From: Mark McLoughlin <markmc@redhat.com>
Date: Mon, 5 Sep 2011 06:59:45 +0100
Subject: [PATCH] Add INPUT chain rule for EC2 metadata requests

On Fedora, the default policy for the INPUT chain in the filter table
is DROP. This means that EC2 metadata requests from guests get dropped.

Add this rule to let it through:

 $> sudo iptables -t filter -A nova-network-INPUT \
                  -s 0.0.0.0/0 -d $ec2_dmz_host \
                  -m tcp -p tcp --dport $ec2_port -j ACCEPT

However, this only works if nova-network and nova-api are on the same
host.
---
 nova/network/linux_net.py |    4 ++++
 1 files changed, 4 insertions(+), 0 deletions(-)

diff --git a/nova/network/linux_net.py b/nova/network/linux_net.py
index dc0d2ca..2a37780 100644
--- a/nova/network/linux_net.py
+++ b/nova/network/linux_net.py
@@ -376,6 +376,10 @@ def metadata_forward():
                                           '-p tcp -m tcp --dport 80 -j DNAT '
                                           '--to-destination %s:%s' % \
                                           (FLAGS.ec2_dmz_host, FLAGS.ec2_port))
+    iptables_manager.ipv4['filter'].add_rule('INPUT',
+                                             '-s 0.0.0.0/0 -d %s '
+                                             '-p tcp -m tcp --dport %s -j ACCEPT' % \
+                                             (FLAGS.ec2_dmz_host, FLAGS.ec2_port))
     iptables_manager.apply()
 
 
-- 
1.7.4.4

